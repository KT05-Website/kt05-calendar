import Stripe from "stripe";
import { buffer } from "micro";
import sgMail from "@sendgrid/mail";

sgMail.setApiKey(process.env.SENDGRID_API_KEY!);

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY as string, {
  apiVersion: "2025-07-30.basil",
});

export async function handler(event: any) {
  if (event.httpMethod !== "POST") {
    return {
      statusCode: 405,
      body: JSON.stringify({ error: "Method not allowed" }),
    };
  }

  try {
    const sig = event.headers["stripe-signature"];
    const buf = Buffer.from(event.body, "utf8");

    let stripeEvent;
    try {
      stripeEvent = stripe.webhooks.constructEvent(
        buf,
        sig!,
        process.env.STRIPE_WEBHOOK_SECRET!
      );
    } catch (err: any) {
      console.error("Webhook signature verification failed:", err.message);
      return { statusCode: 400, body: `Webhook Error: ${err.message}` };
    }

    // Handle successful payment
    if (stripeEvent.type === "checkout.session.completed") {
      const session = stripeEvent.data.object as Stripe.Checkout.Session;
      const metadata = session.metadata || {};

      // Prepare email content
      const emailHtml = `
        <h2>New Custom Sneaker Order</h2>
        <p><strong>Sneaker:</strong> ${metadata.sneaker}</p>
        <p><strong>Package:</strong> ${metadata.packageOption}</p>
        <p><strong>Size:</strong> ${metadata.shoeSize}</p>
        <p><strong>Lace Color:</strong> ${metadata.laceColor}</p>
        <p><strong>Description:</strong> ${metadata.description}</p>
        <p><strong>Images:</strong> ${metadata.images}</p>
        <p><strong>Customer:</strong> ${metadata.contact_name} (${metadata.contact_email}, ${metadata.contact_phone})</p>
        <hr />
        <p>Add a calendar link manually or via Google API next.</p>
      `;

      // Send internal notification email
      await sgMail.send({
        to: process.env.INTERNAL_ORDER_EMAIL!,
        from: process.env.SENDGRID_FROM_EMAIL!,
        subject: "New Custom Sneaker Order",
        html: emailHtml,
      });

      // Send confirmation email to customer (with calendar booking link)
      await sgMail.send({
        to: metadata.contact_email,
        from: process.env.SENDGRID_FROM_EMAIL!,
        subject: "Your KT05 Custom Sneaker Order Confirmation",
        html: `
          <h2>Thank you for your order!</h2>
          <p>Weâ€™ve received your design and will start processing soon.</p>
          <p>You can book your consultation here: 
          <a href="${process.env.CALENDAR_BOOKING_URL}" target="_blank">Book Consultation</a></p>
        `,
      });
    }

    return { statusCode: 200, body: JSON.stringify({ received: true }) };
  } catch (error: any) {
    console.error("Error handling webhook:", error);
    return {
      statusCode: 500,
      body: JSON.stringify({ error: "Webhook handler failed" }),
    };
  }
}